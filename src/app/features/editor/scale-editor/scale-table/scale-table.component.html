<!--
SPDX-FileCopyrightText: 2022 Argho Tuning Project Authors

SPDX-License-Identifier: Apache-2.0
-->

<div class="scale-table-wrapper">

<table #scaleTable mat-table [dataSource]="dataSource" class="scale-table mat-elevation-z2"
       (click)="handleTableClick($event)">
  <ng-container [matColumnDef]="ScaleTableCol.INPUT_KEY">
    <th mat-header-cell *matHeaderCellDef></th>
    <td mat-cell *matCellDef="let element">
      <span class="scale-in-key">
        <app-spelled-pitch *ngIf="element.firstMappedPitch" [pitch]="element.firstMappedPitch"></app-spelled-pitch>
        <ng-container *ngIf="!element.firstMappedPitch">-</ng-container>
      </span>
    </td>
  </ng-container>

  <ng-container [matColumnDef]="ScaleTableCol.DEG">
    <th mat-header-cell *matHeaderCellDef><span class="scale-deg">Deg.</span></th>
    <td mat-cell *matCellDef="let element">
      <span class="scale-deg">{{element.deg.displayNumber}}</span>
    </td>
  </ng-container>

  <ng-container [matColumnDef]="ScaleTableCol.MEASURE_FROM">
    <th mat-header-cell *matHeaderCellDef>
      <div class="scale-measure-from-wrapper">
        <span class="scale-measure-from">Meas.<br>From</span>
        <button mat-button [matMenuTriggerFor]="measFromMenu" aria-label="Select a measure from preset">
          <fa-icon [icon]="faAngleDown"></fa-icon>
        </button>
        <mat-menu #measFromMenu="matMenu">
          <div class="menu-header">Measure all from</div>
          <button mat-menu-item (click)="setMeasureFromScaleRoot()">Root</button>
          <button mat-menu-item (click)="setMeasureFromDegBelow()">Degree Below</button>
        </mat-menu>
      </div>
    </th>
    <td mat-cell *matCellDef="let element" [ngClass]="{'editable': element.editable}">
      <span class="scale-measure-from">{{element.measureFrom?.displayNumber || '-'}}</span>
    </td>
  </ng-container>

  <ng-container [matColumnDef]="ScaleTableCol.RATIO">
    <th mat-header-cell *matHeaderCellDef><span class="scale-ratio">Ratio</span></th>
    <td mat-cell *matCellDef="let element" [ngClass]="{'editable': element.editable}">
      <span class="scale-ratio">
        <ng-container *ngIf="element.ratio">{{element.ratio}}</ng-container>
        <ng-container *ngIf="!element.ratio">-</ng-container>
      </span>
    </td>
  </ng-container>

  <ng-container [matColumnDef]="ScaleTableCol.CENTS">
    <th mat-header-cell *matHeaderCellDef><span class="scale-cents">Cents</span></th>
    <td mat-cell *matCellDef="let element" [ngClass]="{'editable': element.editable}">
      <span class="scale-cents">
        <ng-container *ngIf="element.cents">{{element.cents}}</ng-container>
        <ng-container *ngIf="!element.cents">-</ng-container>
      </span>
    </td>
  </ng-container>

  <ng-container [matColumnDef]="ScaleTableCol.FREQ">
    <th mat-header-cell *matHeaderCellDef><span class="scale-freq">Freq (Hz)</span></th>
    <td mat-cell *matCellDef="let element" [ngClass]="{'editable': element.editable}">
      <span class="scale-freq">
        {{element.freqHz}}
        <button mat-button class="play-button" aria-label="Play"
                (mousedown)="playDegree(element.deg.index)"
                (mouseup)="stopDegree(element.deg.index)">
          <fa-icon [icon]="faPlayCircle"></fa-icon>
        </button>
      </span>
    </td>
  </ng-container>

  <ng-container [matColumnDef]="ScaleTableCol.NEAREST_12TET_PITCH">
    <th mat-header-cell *matHeaderCellDef><span>Nearest<br>12TET</span></th>
    <td mat-cell *matCellDef="let element">
      <app-spelled-pitch class="scale-nearest-pitch" [pitch]="element.ref12tetPitch"></app-spelled-pitch>
      <!-- TODO: Also add frequency + play button. -->
    </td>
  </ng-container>

  <ng-container [matColumnDef]="ScaleTableCol.CENTS_FROM_12TET">
    <th mat-header-cell *matHeaderCellDef>Î”&nbsp;Cents</th>
    <td mat-cell *matCellDef="let element" [ngClass]="{'editable': element.editable}">
      <span class="scale-12tet-offset">{{element.centsFrom12tet}}</span>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns;" [attr.data-deg-idx]="row.deg.index"></tr>
</table>

<mat-card #popupEditor class="scale-field-editor mat-elevation-z6"
          [style.display]="showPopupEditor ? 'block' : 'none'">
  <mat-form-field #popupField appearance="standard">
    <mat-label>{{popupLabel}}</mat-label>
    <input #popupInput matInput (blur)="handlePopupInputBlur()">
  </mat-form-field>
</mat-card>

</div>
